<!DOCTYPE html><html lang="en-GB" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Unity - Animation-synced movement" /><meta property="og:locale" content="en_GB" /><meta name="description" content="I’ve recently been working on a side project with a couple of friends using Unity. It’s a hand-drawn game that takes place inside a cosy cafe in a small town populated by animals. It’s slow-paced, at a 2.5D perspective, with a focus on atmosphere and narrative, so we want to pay a lot of attention to how the game looks and feels." /><meta property="og:description" content="I’ve recently been working on a side project with a couple of friends using Unity. It’s a hand-drawn game that takes place inside a cosy cafe in a small town populated by animals. It’s slow-paced, at a 2.5D perspective, with a focus on atmosphere and narrative, so we want to pay a lot of attention to how the game looks and feels." /><link rel="canonical" href="https://games-hardy.com//posts/unity-animation-syncing/" /><meta property="og:url" content="https://games-hardy.com//posts/unity-animation-syncing/" /><meta property="og:site_name" content="James Hardy" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-07-21T10:00:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Unity - Animation-synced movement" /><meta name="twitter:site" content="@_Nindigo" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"mainEntityOfPage":{"@type":"WebPage","@id":"https://games-hardy.com//posts/unity-animation-syncing/"},"description":"I’ve recently been working on a side project with a couple of friends using Unity. It’s a hand-drawn game that takes place inside a cosy cafe in a small town populated by animals. It’s slow-paced, at a 2.5D perspective, with a focus on atmosphere and narrative, so we want to pay a lot of attention to how the game looks and feels.","url":"https://games-hardy.com//posts/unity-animation-syncing/","@type":"BlogPosting","headline":"Unity - Animation-synced movement","dateModified":"2021-07-25T13:09:17+01:00","datePublished":"2021-07-21T10:00:00+01:00","@context":"https://schema.org"}</script><title>Unity - Animation-synced movement | James Hardy</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="James Hardy"><meta name="application-name" content="James Hardy"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">James Hardy</a></div><div class="site-subtitle font-italic"><p>Game Systems Engineer, UK</p><p>C++, Java, C#</p></div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/mywork/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>MY WORK</span> </a><li class="nav-item"> <a href="/blogs" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>BLOGS</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/nin1" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/_Nindigo" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['jamesmhardy33','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Unity - Animation-synced movement</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Unity - Animation-synced movement</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> James Hardy </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Wed, Jul 21, 2021, 10:00 AM +0100" prep="on" > Jul 21 <i class="unloaded">2021-07-21T10:00:00+01:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sun, Jul 25, 2021, 1:09 PM +0100" prefix="Updated " > Jul 25 <i class="unloaded">2021-07-25T13:09:17+01:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="819 words">4 min</span></div></div><div class="post-content"><p>I’ve recently been working on a side project with a couple of friends using Unity. It’s a hand-drawn game that takes place inside a cosy cafe in a small town populated by animals. It’s slow-paced, at a 2.5D perspective, with a focus on atmosphere and narrative, so we want to pay a lot of attention to how the game looks and feels.</p><h2 id="creating-our-walk-cycle">Creating Our Walk Cycle</h2><hr /><p>Once we had settled on a theme, one of the first things we wanted to work on was the look of the game. Our very talented artist Lark whipped up a cute idle animation for the player character, at 12 frames-per-second, and we knew immediately that this is what we’re going for. The next step was a walk-cycle, which had a few pre-requisites.</p><p>First, we needed to decide on a movement speed, which in turn required a rough to-scale environment so we could properly feel it out. To keep things simple, the character moves at a fixed speed with no acceleration or deceleration One we were happy with the movement speed, we measured the distance moved in one second and divided it by twelve to get the distance moved per-animation-frame, assuming a 12fps animation. We then placed markers at intervals this distance apart, and used that as a reference for Lark to animate over.</p><p><img data-proofer-ignore data-src="https://games-hardy.com//assets/posts/2021-07-21-unity-animation-sync/rough-animation.png" alt="animation-reference" /></p><p>Sweet! Our character animated in-time with the movement, so their feet shouldn’t be sliding around the ground. Except, we weren’t quite satisfied yet. The character entity is moving on Unity’s Update loop which runs every time the game draws a frame, which on most machines this will be much more often than 12 times per second. If the game is running at 60fps, that means each animation frame is being displayed for 5 game-frames at a time, which still causes a very subtle ‘sliding’ effect.</p><video muted="" autoplay="" loop=""> <source src="/assets/posts/2021-07-21-unity-animation-sync/sliding.webm" type="video/mp4" /> </video><h2 id="fixing-our-walk-cycle">Fixing Our Walk Cycle</h2><p>The solution might seem pretty obvious - the character entity should only move every 1/12th of a second, in-sync with the animation, so that the entity only moves when the animation frame changes. How to actually achieve this isn’t so obvious, though. The character moves using a Unity CharacterController, and has a Rigidbody for collisions. This means that the movement is largely controlled by Unity’s physics timestep, which takes away a lot of our control over the character’s movement.</p><p>Instead, I made the sprite its own GameObject as a child of the character’s main GameObject. On the sprite GameObject, I have a script that stores the position of its parent every 1/12th of a second, and each LateUpdate it will move itself back to the stored position. The script uses deltaTime, the time since the last frame, to count down to when to store a new position.</p><div lang="c#" class="language-c# highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="c1">// Called every 1/12th of a second</span>
<span class="k">void</span> <span class="nf">UpdatePosition</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">transform</span><span class="p">.</span><span class="n">localPosition</span> <span class="p">=</span> <span class="n">Vector3</span><span class="p">.</span><span class="n">zero</span><span class="p">;</span>
    <span class="n">m_storedPos</span> <span class="p">=</span> <span class="n">transform</span><span class="p">.</span><span class="n">position</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">void</span> <span class="nf">LateUpdate</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">transform</span><span class="p">.</span><span class="n">position</span> <span class="p">=</span> <span class="n">m_storedPos</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>This very nearly works, but I don’t trust that this will eventually de-sync from the animation slightly and cause something very strange-looking. What we really need is for the script to listen to the Animator component itself, so it knows exactly when the animation frame has changed.</p><div lang="c#" class="language-c# highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="c1">// Add an event to every frame in every animation</span>
<span class="k">foreach</span> <span class="p">(</span><span class="n">AnimationClip</span> <span class="n">clip</span> <span class="k">in</span> <span class="n">m_animator</span><span class="p">.</span><span class="n">runtimeAnimatorController</span><span class="p">.</span><span class="n">animationClips</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Get the framerate and number of frames</span>
    <span class="kt">int</span> <span class="n">numFrames</span> <span class="p">=</span> <span class="n">Mathf</span><span class="p">.</span><span class="nf">RoundToInt</span><span class="p">(</span><span class="n">clip</span><span class="p">.</span><span class="n">length</span> <span class="p">*</span> <span class="n">clip</span><span class="p">.</span><span class="n">frameRate</span><span class="p">);</span>
    <span class="kt">float</span> <span class="n">secondsPerFrame</span> <span class="p">=</span> <span class="m">1.0f</span> <span class="p">/</span> <span class="n">clip</span><span class="p">.</span><span class="n">frameRate</span><span class="p">;</span>

    <span class="c1">// Add an event on every frame of the animation</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">numFrames</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="n">AnimationEvent</span> <span class="n">evt</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">AnimationEvent</span><span class="p">();</span>
        <span class="n">evt</span><span class="p">.</span><span class="n">time</span> <span class="p">=</span> <span class="n">i</span> <span class="p">*</span> <span class="n">secondsPerFrame</span><span class="p">;</span>
        <span class="n">evt</span><span class="p">.</span><span class="n">functionName</span> <span class="p">=</span> <span class="s">"UpdatePosition"</span><span class="p">;</span>
        <span class="n">clip</span><span class="p">.</span><span class="nf">AddEvent</span><span class="p">(</span><span class="n">evt</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>This isn’t actually too hard; you can set up animation events via script, so when the player character spawns, this script will add our “StorePosition” method as an event to each frame of the walk animation. I’m not too sure how the animation system ends up calling these events, but I can’t imagine it will be particularly expensive even with an event every frame. The result is incredibly satisfting:</p><video muted="" autoplay="" loop=""> <source src="/assets/posts/2021-07-21-unity-animation-sync/no-sliding.webm" type="video/mp4" /> </video><p>Look how firmly their feet plant on the ground! We can now really appreciate how wonderful this little animation is while we play the game. Physics and collisions will behave exactly as they did before, and we don’t introduce any input lag as the animation itself can start ASAP. For a slow-paced game like this, the gameplay is not hurt by lowering the character’s framerate, and it makes the movement feel incredibly polished.</p><hr /><p>There’s a bit more to discuss on this topic, particularly when the camera starts moving, but for now we will call this a job well-done. If you think this walk cycle is as amazing as I do, I encourage you to check out more of Lark’s work at <a href="https://www.artstation.com/larkmoerschell">their Artstation page</a>.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href="//categories/blogs/" >blogs</a >, <a href="//categories/unity/" >Unity</a ></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="//tags/unity/" class="post-tag no-text-decoration" >Unity</a> <a href="//tags/c/" class="post-tag no-text-decoration" >C#</a> <a href="//tags/animation/" class="post-tag no-text-decoration" >animation</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2" ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/" >CC BY 4.0</a > by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Unity - Animation-synced movement - James Hardy&url=https://games-hardy.com//posts/unity-animation-syncing/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Unity - Animation-synced movement - James Hardy&u=https://games-hardy.com//posts/unity-animation-syncing/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Unity - Animation-synced movement - James Hardy&url=https://games-hardy.com//posts/unity-animation-syncing/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span >Recent Update</span ><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/dark-tower/">Porting a 40-Year-Old Board Game to Unity</a><li><a href="/posts/university/">University - LOD & Tessellation</a><li><a href="/posts/unity-animation-syncing/">Unity - Animation-synced movement</a><li><a href="/posts/runescape/">RuneScape & Old School RuneScape</a><li><a href="/posts/runescape-smooth-movement/">RuneScape - Smooth Movement</a></ul></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4" ></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/_Nindigo">James Hardy</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/c/">C#</a> <a class="post-tag" href="/tags/game-engine/">game engine</a> <a class="post-tag" href="/tags/unity/">Unity</a> <a class="post-tag" href="/tags/c/">C++</a> <a class="post-tag" href="/tags/runescape/">RuneScape</a> <a class="post-tag" href="/tags/animation/">animation</a> <a class="post-tag" href="/tags/asm/">asm</a> <a class="post-tag" href="/tags/css/">css</a> <a class="post-tag" href="/tags/graphics/">graphics</a> <a class="post-tag" href="/tags/html/">html</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://games-hardy.com/{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script async src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script>
